# Полная автоматизация: ты только команды, всё остальное — агент и CI/CD

Цель: ты даёшь продуктовые команды в чате (например «сделай X на стаджинге» / «выкати на прод»), а **агент сам** коммитит, пушит в Git, а деплой и действия на VPS выполняет GitHub Actions. Ты никуда не заходишь, ничего не пушишь и не запускаешь на VPS.

---

## Что уже работает без тебя

| Действие | Кто делает |
|----------|------------|
| Деплой на стаджинг при пуше в `staging` | GitHub Actions |
| Деплой на прод при пуше в `main` | GitHub Actions |
| Запуск скрипта создания премиум/админ на стаджинге | GitHub Actions (добавлен шаг в workflow) |

То есть: **как только в репозитории появляется пуш в `staging` или `main`**, всё остальное (код на VPS, перезапуск бэкенда, создание/обновление тестовых пользователей на стаджинге) делается автоматически.

---

## Что мешает полной автоматизации

Единственное узкое место: **пуш в Git из Cursor (агент)**.

Агент может выполнять у себя `git add`, `git commit`, `git push origin staging` (или `main`). Но **`git push` у тебя падает**, потому что репозиторий настроен на HTTPS, а в среде, где работает агент, нет доступа к твоему GitHub (нет логина/пароля или токена). То есть агент не может «сам всё лить на стаджинг в гите» — не из-за логики, а из-за доступа к GitHub.

---

## Что сделать один раз, чтобы агент мог пушить

Нужно, чтобы **на той машине, где ты открываешь проект в Cursor** (WSL/Ubuntu), `git push` выполнялся **без запроса пароля**. Тогда когда агент выполнит `git push origin staging` или `git push origin main`, пуш реально уйдёт в GitHub, и дальше всё продолжит делать CI/CD.

### Вариант A: SSH (рекомендуется)

1. **SSH-ключ без пароля** (или с паролем, но тогда перед работой один раз в сессии: `ssh-add`):
   ```bash
   ssh-keygen -t ed25519 -C "github-matchacalc" -f ~/.ssh/id_ed25519_matchacalc -N ""
   ```
2. **Публичный ключ** добавь в GitHub:  
   `Settings` → `SSH and GPG keys` → `New SSH key` → вставь содержимое `~/.ssh/id_ed25519_matchacalc.pub`.
3. **В репозитории** переключи remote на SSH:
   ```bash
   cd /home/nikit/matchacalc
   git remote set-url origin git@github.com:avraamsonofsky/matchacalc.git
   ```
4. **Проверка** (в том же WSL, где открыт Cursor):
   ```bash
   git push origin staging
   ```
   Если пуш прошёл без запроса пароля — всё ок. Тогда и агент в Cursor сможет пушить, когда будет выполнять эту команду.

После этого сценарий такой: ты говоришь «сделай X на стаджинге» → агент правит код, делает `git add`, `git commit`, `git push origin staging` → GitHub Actions деплоит на стаджинг и при необходимости запускает скрипты на VPS. Ты никуда не заходишь и ничего не пушишь.

### Вариант B: токен в URL (если SSH не хочешь)

1. В GitHub: `Settings` → `Developer settings` → `Personal access tokens` → создать токен с правом `repo`.
2. Локально (один раз):
   ```bash
   git remote set-url origin https://<TOKEN>@github.com/avraamsonofsky/matchacalc.git
   ```
   Токен будет в конфиге репозитория — не выкладывай его в публичный репозиторий и не коммить `.git` наружу.

Тогда `git push` тоже будет проходить без ввода пароля, и агент сможет пушить.

---

## Итоговая схема после настройки

1. Ты в Cursor даёшь команду: «сделай X на стаджинге» или «выкати на прод».
2. Агент в чате:
   - вносит изменения в код;
   - выполняет `git add`, `git commit`, `git push origin staging` (или `main`).
3. GitHub Actions:
   - при пуше в `staging`: деплой на стаджинг, перезапуск бэкенда, при необходимости запуск `create_staging_users.py`;
   - при пуше в `main`: деплой на прод, перезапуск бэкенда.
4. Ты не ходишь в Git, не пушишь вручную и не заходишь на VPS — всё делают агент и пайплайн.

Единственное разовое действие с твоей стороны — настроить пуш без пароля (SSH или токен), как выше. После этого «лить всё на стаджинг в гите» и «лить на прод» будет именно агент через `git push`, а на VPS всё будет делать GitHub Actions.
