name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy backend code to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: "matchacalc-backend/"
          target: "/root/matchacalc-backend/"
      
      - name: Deploy frontend code to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: "matchacalc-frontend/"
          target: "/var/www/lattecalc/"
      
      - name: Setup and restart backend on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            set -e
            set -x
            
            echo "=== Step 1: Stopping old backend process ==="
            # Безопасная остановка: находим PID и убиваем только его
            OLD_PID=$(pgrep -f "uvicorn.*app.main:app.*3000" || true)
            if [ ! -z "$OLD_PID" ]; then
              echo "Found old process with PID: $OLD_PID"
              kill $OLD_PID 2>/dev/null || true
              sleep 2
              # Проверяем, что процесс действительно остановился
              if ps -p $OLD_PID > /dev/null 2>&1; then
                echo "Process still running, force killing..."
                kill -9 $OLD_PID 2>/dev/null || true
              fi
            else
              echo "No old process found"
            fi
            sleep 1
            
            echo "=== Step 2: Changing to backend directory ==="
            cd /root/matchacalc-backend || { echo "Directory not found!"; exit 1; }
            pwd
            
            echo "=== Step 3: Creating virtual environment if needed ==="
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv || { echo "Failed to create venv!"; exit 1; }
            fi
            
            echo "=== Step 4: Activating virtual environment ==="
            source .venv/bin/activate || { echo "Failed to activate venv!"; exit 1; }
            which python
            which pip
            
            echo "=== Step 5: Installing/updating dependencies ==="
            pip install --upgrade pip --quiet
            pip install -r requirements.txt --quiet || { echo "Failed to install dependencies!"; exit 1; }
            
            echo "=== Step 6: Setting environment variables ==="
            export DATABASE_URL="${{ secrets.PROD_DATABASE_URL }}"
            export REDIS_URL="${{ secrets.PROD_REDIS_URL }}"
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            export JWT_ALGORITHM=HS256
            export ACCESS_TOKEN_EXPIRE_MINUTES=129600
            export RATE_LIMIT_GUEST=180
            export RATE_LIMIT_USER=60
            export RATE_LIMIT_SUBSCRIBER=10
            
            echo "=== Step 7: Starting backend on port 3000 ==="
            nohup .venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 3000 > /root/backend-prod.log 2>&1 &
            BACKEND_PID=$!
            echo "Backend started with PID: $BACKEND_PID"
            
            echo "=== Step 8: Waiting for backend to start ==="
            sleep 3
            
            echo "=== Step 9: Checking if backend process is running ==="
            if ps -p $BACKEND_PID > /dev/null 2>&1; then
              echo "Backend process is running (PID: $BACKEND_PID)"
            else
              echo "Backend process died! Checking logs:"
              tail -20 /root/backend-prod.log || true
              exit 1
            fi
            
            echo "=== Step 10: Testing backend health endpoint ==="
            sleep 2
            curl -f http://localhost:3000/api/v1/health || { 
              echo "Health check failed! Checking logs:"
              tail -20 /root/backend-prod.log || true
              exit 1
            }
            
            echo "=== Deployment completed successfully ==="
