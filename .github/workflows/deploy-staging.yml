name: Deploy to Staging

on:
  push:
    branches:
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy backend code to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: "matchacalc-backend/"
          target: "/root/matchacalc-backend/"
      
      - name: Deploy frontend code to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: "matchacalc-frontend/"
          target: "/var/www/lattecalc/"
      
      - name: Setup and restart backend on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            set -e
            echo "=== Stopping old backend process ==="
            pkill -f "uvicorn.*matchacalc.*staging" || pkill -f "uvicorn.*app.main:app.*8080" || true
            sleep 2
            
            echo "=== Setting up backend directory ==="
            cd /root/matchacalc-backend
            
            echo "=== Creating virtual environment if needed ==="
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi
            
            echo "=== Activating virtual environment and installing dependencies ==="
            source .venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            
            echo "=== Setting environment variables ==="
            export DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}"
            export REDIS_URL="${{ secrets.STAGING_REDIS_URL }}"
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            export JWT_ALGORITHM=HS256
            export ACCESS_TOKEN_EXPIRE_MINUTES=129600
            export RATE_LIMIT_GUEST=180
            export RATE_LIMIT_USER=60
            export RATE_LIMIT_SUBSCRIBER=10
            
            echo "=== Starting backend on port 8080 ==="
            nohup .venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8080 > /root/backend-staging.log 2>&1 &
            
            echo "=== Waiting for backend to start ==="
            sleep 5
            
            echo "=== Checking if backend is running ==="
            ps aux | grep "[u]vicorn.*8080" || (echo "Backend not running!" && exit 1)
            
            echo "=== Testing backend health ==="
            curl -f http://localhost:8080/api/v1/health || (echo "Health check failed!" && exit 1)
            
            echo "=== Deployment completed successfully ==="
