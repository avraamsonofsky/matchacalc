name: Deploy to Staging

on:
  push:
    branches:
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Ensure staging directories exist on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            mkdir -p /root/matchacalc-backend-staging
            mkdir -p /var/www/staging
      
      - name: Deploy backend code to VPS (staging)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: "matchacalc-backend/"
          target: "/root/matchacalc-backend-staging/"
      
      - name: Deploy frontend code to VPS (staging)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: "matchacalc-frontend/"
          target: "/var/www/staging/"
      
      - name: Setup and restart backend on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            set -e
            set -x
            
            echo "=== Step 1: Stopping old backend process ==="
            # Освобождаем порт 8080, если он занят
            if command -v fuser >/dev/null 2>&1; then
              fuser -k 8080/tcp 2>/dev/null || true
              sleep 1
            else
              # Если fuser нет, пытаемся найти и убить процесс на порту
              PORT_PID=$(lsof -ti:8080 2>/dev/null || true)
              if [ ! -z "$PORT_PID" ]; then
                echo "Found process using port 8080: $PORT_PID"
                kill $PORT_PID 2>/dev/null || true
                sleep 1
              fi
            fi
            
            echo "=== Step 2: Changing to staging backend directory ==="
            cd /root/matchacalc-backend-staging || { echo "Directory not found!"; exit 1; }
            # scp-action creates nested folder: target/matchacalc-backend/
            if [ -f matchacalc-backend/requirements.txt ]; then
              cd matchacalc-backend
            fi
            pwd
            ls -la
            
            echo "=== Step 3: Creating virtual environment if needed ==="
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv || { echo "Failed to create venv!"; exit 1; }
            fi
            
            echo "=== Step 4: Activating virtual environment ==="
            source .venv/bin/activate || { echo "Failed to activate venv!"; exit 1; }
            which python
            which pip
            
            echo "=== Step 5: Installing/updating dependencies ==="
            pip install --upgrade pip --quiet
            pip install -r requirements.txt --quiet || { echo "Failed to install dependencies!"; exit 1; }
            
            echo "=== Step 6: Setting environment variables ==="
            export DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}"
            export REDIS_URL="${{ secrets.STAGING_REDIS_URL }}"
            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
            export JWT_ALGORITHM=HS256
            export ACCESS_TOKEN_EXPIRE_MINUTES=129600
            export RATE_LIMIT_GUEST=180
            export RATE_LIMIT_USER=60
            export RATE_LIMIT_SUBSCRIBER=10
            
            echo "=== Step 7: Starting backend on port 8080 ==="
            # Запускаем процесс полностью отвязанным от SSH сессии
            nohup .venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8080 > /root/backend-staging.log 2>&1 &
            BACKEND_PID=$!
            disown $BACKEND_PID 2>/dev/null || true
            echo "Backend started with PID: $BACKEND_PID"
            
            echo "=== Step 8: Waiting for backend to start ==="
            sleep 3
            
            echo "=== Step 9: Checking if backend process is running ==="
            if ps -p $BACKEND_PID > /dev/null 2>&1; then
              echo "Backend process is running (PID: $BACKEND_PID)"
            else
              echo "Backend process died! Checking logs:"
              tail -20 /root/backend-staging.log || true
              exit 1
            fi
            
            echo "=== Step 10: Testing backend health endpoint ==="
            sleep 2
            curl -f http://localhost:8080/api/v1/health || { 
              echo "Health check failed! Checking logs:"
              tail -20 /root/backend-staging.log || true
              exit 1
            }
            
            echo "=== Deployment completed successfully ==="
