# Техническое задание  
**Проект:** MatchaCalc — калькулятор доходности коммерческой недвижимости  
**Слоган:** «Считай доходность помещений, пока пьёшь матча‑латте»

---

## 1. Цель и концепция продукта

MatchaCalc — веб‑сервис для оценки инвестиционной привлекательности офисной недвижимости Москвы (и далее — других сегментов), основанный на:

- открытых консалтинговых отчётах (Nikoliers, NF Group и др.);
- автоматическом парсинге данных по конкретным лотам с Циан;
- простой, но честной инвест‑математике (окупаемость, рост стоимости, арендный поток) плюс проф‑метрики NPV и IRR.

Продукт предназначен для:

- частных инвесторов;
- брокеров и агентов по коммерческой недвижимости;
- девелоперов/застройщиков (через подписку и последующий API‑доступ).

---

## 2. Пользовательские роли и доступ

### 2.1. Неавторизованный пользователь (гость)

Права:

- Доступ к главной странице с калькулятором.
- Ввод стоимости, площади, района (агрегированная группа), даты РВЭ, срока владения, выбор сценария и отчёта.
- Просмотр всех расчётных метрик (включая NPV и IRR).
- Лимит расчётов: **1 расчёт раз в 3 минуты** (по IP + fingerprint/куки).
- Просмотр публичных коллекций по уникальной ссылке (без редактирования).

Ограничения:

- Окно «Вставьте ссылку из Циан» отображается в мутном состоянии с подсказкой «доступно только по подписке».
- Страница коллекций доступна только для просмотра пустого состояния; кнопки создания коллекций и добавления лотов — в мутном состоянии.

### 2.2. Авторизованный пользователь без подписки

Права:

- Всё, как у гостя, плюс:
  - Лимит расчётов: **1 расчёт раз в 1 минуту**.
  - Возможность войти/выйти, базовый личный кабинет (профиль, статус подписки).
  - Переход на страницу коллекций (просмотр пустого состояния, без активных действий).

Ограничения:

- Парсинг Циан и создание коллекций остаются недоступны (мутные кнопки с подсказкой).

### 2.3. Пользователь с подпиской «Агент»

Права:

- Все возможности авторизованного пользователя.
- Лимит расчётов: **1 новый расчёт раз в 10 секунд**.
- Разблокирована функция вставки ссылок с Циан для:
  - автозаполнения калькулятора;
  - массового импорта лотов в коллекции.
- Доступ к функционалу коллекций:
  - создание коллекций;
  - добавление до 20 лотов в коллекцию через ссылки Циан;
  - генерация и шаринг уникальных публичных ссылок на коллекции.

### 2.4. Пользователь с подпиской «Застройщик»

Права:

- Все права пользователя «Агент».
- Дополнительно (v1.1+ / задел в архитектуре):
  - прицельные условия доступа (отдельный тариф, поддержка большего объёма лотов и запросов);
  - в будущем — доступ к расширенному API (массовый импорт объектов, агрегированная аналитика портфеля).

### 2.5. Администратор

Права:

- Управление пользователями и их подписками.
- Управление сценариями (пессимистичный/базовый/оптимистичный).
- Управление группами локаций и их маппингом к субрынкам консалтинговых отчётов.
- Управление отчётами (Nikoliers, NF Group и др.) и параметрами рынка (ставки, прогнозы).
- Управление текстами договоров/политик/дисклеймеров.

---

## 3. Основной функционал

### 3.1. Калькулятор инвестиций

#### 3.1.1. Входные данные (ручной ввод)

Поля:

- **Стоимость объекта (P0)** — число, рубли (например, 50 000 000).
- **Площадь (A)** — число, квадратные метры.
- **Район Москвы (агрегированная группа)** — выпадающий список:
  - Москва‑Сити;
  - Большой Сити;
  - Центр внутри ТТК;
  - Внутри МКАД вне ТТК;
  - За МКАД.
- **Дата РВЭ** — дата (YYYY‑MM‑DD).
- **Срок владения (N)** — ползунок в годах от 1 до 15, шаг — 1 год.
- **Прогноз** — селектор:
  - Пессимистичный;
  - Базовый (по умолчанию);
  - Оптимистичный.
- **Консалтинговый отчёт** — селектор:
  - Nikoliers (Q3 2025, далее обновления);
  - NF Group (актуальный квартал);
  - (в будущем) другие.

#### 3.1.2. Входные данные (через ссылку Циан, только для подписки)

Если пользователь с подпиской:

- Под полем стоимости отображается активное поле ввода «Вставьте ссылку из Циан».
- После вставки и успешного парсинга:
  - Стоимость объекта, площадь, адрес, дата РВЭ заполняются автоматически;
  - Район выбирается автоматически по маппингу адреса к группе локаций (через геокодер/внутренний справочник);
  - Пользователь может при необходимости скорректировать стоимость (например, учесть ожидаемую скидку).

#### 3.1.3. Расчётные показатели

**Статические (не зависят от положения ползунка):**

- Срок окупаемости актива при сдаче с последующей продажей (лет и месяцев).
- Срок увеличения стоимости актива в два раза (лет и месяцев).
- Срок окупаемости при сдаче в аренду (без продажи).

**Динамические (зависят от срока N):**

- Прибыль от продажи объекта (рубли + % к исходной стоимости).
- Прибыль от сдачи в аренду за весь период (рубли + % годовой доходности к вложениям).
- Прибыль от продажи и сдачи в аренду (совокупная, рубли + %).
- NPV (чистая приведённая стоимость) при заданной ставке дисконтирования.
- IRR (внутренняя норма доходности) по всему горизонту владения.

---

## 4. Математическая модель

### 4.1. Базовые параметры

Обозначения:

- P0 — цена покупки.
- A — площадь.
- R0 — стартовая годовая арендная ставка (руб/м²/год) для выбранной группы локаций и класса (A/Prime или B+), берётся из отчёта.
- V0 — стартовая стоимость м² (опционально, если доступна из отчёта).
- g_r — базовый годовой темп роста арендных ставок по выбранной группе локаций.
- g_p — базовый годовой темп роста стоимости актива.
- k_s — коэффициенты сценария (задаются в админке):
  - k_pes < 1,
  - k_base = 1,
  - k_opt > 1.
- d — ставка дисконтирования (задаётся в админке, например, ориентиром служат типичные доходности коммерческой недвижимости и ключевая ставка ЦБ).

Эффективные годовые темпы:

- g_r' = g_r * k_s.
- g_p' = g_p * k_s.

### 4.2. Арендный поток

Принцип: первые 6 месяцев — подготовка и поиск арендатора, далее — аренда.

- Год 1:
  - Rent_1 = 0.5 * A * R0.
- Год t >= 2:
  - Rent_t = A * R0 * (1 + g_r')^(t-2).

Совокупная прибыль от аренды за N лет:
- Прибыль от аренды = SUM(t=1 to N) Rent_t.

### 4.3. Рост стоимости и продажа

Стоимость объекта к концу года t:

- Price_t = P0 * (1 + g_p')^t.

Прибыль от продажи при сроке владения N:

- Прибыль от продажи = Price_N - P0.

### 4.4. Статические сроки

**Срок удвоения стоимости:**

- T_2x = LN(2) / LN(1 + g_p').

**Срок окупаемости при аренде:**

- Находим минимальный t, при котором SUM(i=1 to t) Rent_i >= P0.
- При необходимости допускается линейная интерполяция между годами для перевода в формат «X лет Y месяцев».

**Срок окупаемости при аренде + продаже:**

- Находим минимальный t, при котором SUM(i=1 to t) Rent_i + Price_t >= P0.

### 4.5. Денежные потоки, NPV и IRR

Модель потоков:

- CF_0 = -P0.
- Для лет 1…N-1: CF_t = Rent_t.
- Для года N: CF_N = Rent_N + Price_N.

**NPV:**

- NPV = SUM(t=0 to N) CF_t / (1+d)^t.

**IRR:**

- IRR — ставка r, при которой NPV(r) = 0.
- Вычисляется численно (методом Ньютона или двоичного поиска) с заданной точностью (например, 0.01%).

---

## 5. Архитектура системы

### 5.1. Общая схема

- Отдельный **бэкенд‑сервис** на Python (FastAPI) с REST API.
- Отдельный **фронтенд** (HTML/CSS/JS), общающийся с бэкендом через HTTP/JSON.
- **PostgreSQL** — основная БД.
- **Redis** — кэш + rate‑limiting + очереди задач.
- **Очередь задач** (Celery/RQ) — парсинг Циан и тяжёлые фоновые операции.
- **Nginx** — reverse proxy и статика.
- Проект упакован в Docker‑контейнеры.

Практика: FastAPI хорошо подходит для высоконагруженных API‑ориентированных сервисов и легко масштабируется в микросервисной архитектуре.

### 5.2. Бэкенд: стек и модули

**Стек:**

- Python 3.11+.
- FastAPI.
- SQLAlchemy / SQLModel.
- Alembic (миграции).
- Redis.
- Celery / RQ.
- Uvicorn + gunicorn.

**Модули:**

- `auth` — регистрация/логин/JWT/профиль.
- `users` — управление пользователями и подписками.
- `calc` — модуль расчётов (формулы и сценарии).
- `cian` — интеграция и парсинг.
- `collections` — коллекции лотов и публичные ссылки.
- `reports` — управление консалтинговыми отчётами и рынками.
- `admin` — конфигурация сценариев, отчётов, локаций.
- `billing` — интеграция с платёжной системой, статусы подписок.
- `ratelimit` — ограничения по частоте запросов.
- `logging/monitoring` — логирование, метрики.

### 5.3. Фронтенд: стек и структура

**Стек:**

- Чистый HTML + CSS (по желанию — TailwindCSS/utilities).
- Нативный JavaScript (ES6).
- Без тяжелых SPA‑фреймворков.

**Структура страниц:**

1. `/` — главная страница с калькулятором (главный экран).
2. `/login` — вход.
3. `/register` — регистрация.
4. `/subscription` — страница тарифов.
5. `/collections` — управление коллекциями (для подписчиков).
6. `/c/{slug}` — публичный просмотр коллекции.
7. `/contacts` — контакты/форма связи.

---

## 6. API (черновой контракт)

Все эндпоинты начинаются с `/api/v1`.

### 6.1. Аутентификация

#### POST `/auth/register`

- Вход: `{ "email": "...", "password": "..." }`
- Выход: `{ "id": ..., "email": "...", "created_at": "..." }`

#### POST `/auth/login`

- Вход: `{ "email": "...", "password": "..." }`
- Выход: `{ "access_token": "...", "token_type": "bearer" }`

#### GET `/auth/me`

- Требует Bearer‑токен.
- Выход: `{ "id": ..., "email": "...", "role": "...", "subscription": { ... } }`

### 6.2. Калькулятор

#### POST `/calc/preview`

Назначение: разовый расчёт по ручному вводу.

- Вход:

```json
{
  "purchase_price": 50000000,
  "area": 150,
  "location_group_id": "moscow_city",
  "rve_date": "2026-06-01",
  "holding_years": 7,
  "scenario_id": "base",
  "report_id": "nikoliers_q3_2025"
}
```

- Выход (примерно):

```json
{
  "static_metrics": {
    "payback_rent_years": 9.5,
    "payback_rent_and_sale_years": 6.2,
    "double_price_years": 8.1
  },
  "dynamic_metrics": {
    "holding_years": 7,
    "rent_income_total": 18000000,
    "rent_income_yield_percent": 5.8,
    "sale_profit": 22000000,
    "sale_profit_percent": 44.0,
    "total_profit": 40000000,
    "total_profit_percent": 80.0,
    "npv": 7000000,
    "irr_percent": 11.5
  },
  "cash_flows": [
    { "year": 0, "cf": -50000000 },
    { "year": 1, "cf": 1200000 }
  ]
}
```

Rate‑limiting:

- Гости — не чаще 1 запроса раз в 3 минуты.
- Авторизованные без подписки — 1 раз в 1 минуту.
- Подписчики — 1 раз в 10 секунд.

#### POST `/calc/from-lot/{lot_id}`

Назначение: расчёт по сохранённому лоту.

- Вход:

```json
{
  "holding_years": 10,
  "scenario_id": "opt",
  "report_id": "nikoliers_q3_2025"
}
```

- Выход: тот же формат, что `/calc/preview`.

### 6.3. Лоты (Циан)

#### POST `/lots/import-from-cian`

Только для подписчиков.

- Вход:

```json
{
  "url": "https://www.cian.ru/sale/commercial/12345678/",
  "collection_id": "optional-collection-id"
}
```

- Логика:
  - Добавляет задачу в очередь.
  - Парсер достаёт: стоимость, площадь, адрес, дата РВЭ (по тексту объявления), планировку.
  - Маппит адрес к группе локаций.
  - Создаёт `Lot` в БД.
  - Если указан `collection_id`, связывает с коллекцией.

- Выход:

```json
{
  "task_id": "...",
  "status": "queued"
}
```

#### GET `/lots/{id}`

- Выход:

```json
{
  "id": "...",
  "cian_url": "...",
  "purchase_price": 50000000,
  "area": 150,
  "address": "Москва, Пресненская наб...",
  "location_group_id": "moscow_city",
  "rve_date": "2027-01-01",
  "layout_image_url": "...",
  "custom_discount_percent": 5.0
}
```

### 6.4. Коллекции

#### GET `/collections`

Только для авторизованных.

- Возвращает список коллекций пользователя.

#### POST `/collections`

- Вход:

```json
{
  "name": "Офисы Москва-Сити для инвестора А",
  "description": "Подборка под стратегию 7+ лет..."
}
```

- Выход: `{ "id": "...", "public_slug": null, ... }`

#### POST `/collections/{id}/lots`

- Вход: массив ссылок Циан:

```json
{
  "cian_urls": [
    "https://www.cian.ru/sale/commercial/123/",
    "https://www.cian.ru/sale/commercial/456/"
  ]
}
```

- Для каждой ссылки создаётся задача парсинга и добавляется в коллекцию (max 20 лотов).

#### POST `/collections/{id}/publish`

- Генерирует `public_slug` и делает коллекцию доступной по `/c/{slug}`.

#### GET `/collections/{id}`

- Возвращает структуру коллекции для владельца (включая внутренние ID лотов и настройки).

#### GET `/collections/public/{slug}`

- Публичный просмотр коллекции:

```json
{
  "title": "Офисы Москва-Сити для инвестора А",
  "lots": [
    {
      "id": "...",
      "layout_image_url": "...",
      "address": "...",
      "original_price": 50000000,
      "discounted_price": 47500000,
      "discount_percent": 5.0
    }
  ]
}
```

Фронтенд по этому API отображает плитку карточек; при клике — модалка с калькулятором по конкретному лоту (расчёты через `/calc/from-lot/{lot_id}`).

### 6.5. Отчёты и сценарии

#### GET `/reports`

- Список доступных отчётов и их периодов (Nikoliers Q3 2025, NF Group Q3 2025 и т.д.).

#### GET `/location-groups`

- Список агрегированных локаций с описаниями.

#### GET `/scenarios`

- Список сценариев с кратким описанием (без коэффициентов, они скрыты от пользователя).

#### Админские эндпоинты (`/admin/...`)

- CRUD для `MarketReport`, `LocationGroup`, `ScenarioConfig`.
- Форма для ввода:
  - стартовых ставок аренды;
  - стартовых цен м²;
  - прогнозных значений по годам;
  - агрегированных годовых темпов роста.

---

## 7. Модель данных (БД)

Основные таблицы (упрощённо):

### 7.1. `users`

- `id` (PK)
- `email` (unique)
- `password_hash`
- `role` (enum: user, agent, developer, admin)
- `created_at`, `updated_at`

### 7.2. `subscriptions`

- `id`
- `user_id` (FK → users)
- `plan` (enum: none, agent, developer)
- `started_at`
- `expires_at`
- `status` (active, cancelled, expired)

### 7.3. `location_groups`

- `id` (string, например `moscow_city`)
- `name` (русское имя)
- `description`
- `report_mapping` (JSON, список субрынков/районов, по которым агрегируются данные в рамках отчётов).

### 7.4. `market_reports`

- `id`
- `provider` (nikoliers, nf_group, etc.)
- `title`
- `period` (например, `2025-Q3`)
- `file_url` (ссылка на PDF)
- `active` (bool)

### 7.5. `market_report_values`

- `id`
- `report_id` (FK)
- `location_group_id` (FK)
- `property_class` (A_Prime, B_plus, etc.)
- `rent_start` (R0)
- `rent_growth_annual` (g_r)
- `price_per_m2_start` (V0, опционально)
- `price_growth_annual` (g_p)
- `vacancy_rate` (опционально)

### 7.6. `scenario_configs`

- `id` (pes, base, opt)
- `name` (Пессимистичный, Базовый, Оптимистичный)
- `rent_growth_multiplier` (k_s для аренды)
- `price_growth_multiplier` (k_s для цены)
- `discount_rate_adjustment` (опционально)

### 7.7. `lots`

- `id`
- `owner_user_id` (FK, может быть null для лотов только в коллекциях)
- `cian_url`
- `purchase_price`
- `area`
- `address`
- `location_group_id` (FK)
- `rve_date`
- `layout_image_url` (опционально)
- `custom_discount_percent` (опционально)
- `created_at`, `updated_at`

### 7.8. `collections`

- `id`
- `owner_user_id` (FK)
- `name`
- `description`
- `public_slug` (unique, nullable)
- `created_at`, `updated_at`

### 7.9. `collection_lots`

- `collection_id` (FK)
- `lot_id` (FK)
- `position` (для сортировки)
- PK: `(collection_id, lot_id)`

### 7.10. `calculations`

- `id`
- `user_id` (nullable для гостей)
- `lot_id` (nullable, если рассчитано по лоту)
- `purchase_price`
- `area`
- `location_group_id`
- `rve_date`
- `holding_years`
- `scenario_id`
- `report_id`
- `result_json` (все рассчитанные метрики и cash‑flows)
- `created_at`

---

## 8. Интерфейсы и UX

### 8.1. Главная страница / калькулятор

Верхняя панель:

- Логотип MatchaCalc.
- Меню: **Вход**, **Регистрация**, **Подписка**, **Контакты**.

Первый экран (видим сразу):

- Левая часть:
  - Название: MatchaCalc.
  - Подзаголовок: «Считай доходность помещений, пока пьёшь матча‑латте».
  - Короткий поясняющий текст (1–2 строки).
- Правая/центральная часть:
  - Карточка калькулятора:
    - Поля ввода стоимости, площади, района, даты РВЭ.
    - Выпадающие списки прогноза и отчёта.
    - Ползунок срока владения.
    - Кнопка «Рассчитать» (disabled / loader при запросе).
  - Под полем стоимости:
    - Окно «Вставьте ссылку из Циан»:
      - Для гостей/без подписки — визуально приглушено, внутри надпись «Вставьте ссылку из Циан» + иконка `i`, при наведении tooltip: «Доступно только по подписке».
      - Для подписчиков — активное текстовое поле.

Блок результатов (под калькулятором):

- Левая колонка — статические метрики (3 карточки).
- Правая колонка — динамические результаты для выбранного срока:
  - Прибыль от аренды;
  - Прибыль от продажи;
  - Совокупная прибыль;
  - NPV;
  - IRR.
- Под ними — линейные/минималистичные индикаторы или текстовое объяснение.

Внизу страницы:

- Дисклеймер: текст о том, что сервис не является индивидуальной инвестиционной рекомендацией и использует открытые данные отчётов; результаты не гарантируют доходность и не являются офертой.
- Ссылка на политику конфиденциальности и обработку персональных данных.

### 8.2. Страница «Подписка»

Три столбца:

1. **Без подписки**
   - «Делайте расчёты с ручным вводом».
   - Лимит: 1 раз в 3 минуты.
   - Нет автозаполнения с Циан.
   - Нет коллекций.

2. **Подписка агента**
   - Цена: 2999 ₽/мес (редактируемо в админке).
   - Лимит: 1 расчёт раз в 10 секунд.
   - Автозаполнение с Циан.
   - Коллекции до 20 лотов, публичные ссылки.

3. **Подписка для застройщика**
   - «Уникальные условия, свяжитесь с нами».
   - Кнопка «Связаться» (форма/почта).

### 8.3. Страница коллекций (для подписчика)

- Кнопка «+ Создать коллекцию».
- Список уже созданных коллекций (название, дата, количество лотов, статус публикации).
- При нажатии на коллекцию:
  - Список лотов (карточки).
  - Кнопка «Добавить лоты из Циан» — открывает модалку:
    - Поле ввода ссылки Циан; после вставки и обработки — появляется следующее поле.
    - Ограничение до 20 ссылок.
    - Кнопка «Сохранить».

### 8.4. Публичная страница коллекции `/c/{slug}`

- Заголовок коллекции (название).
- Описание (если есть).
- Сетка карточек лотов:
  - Планировка (картинка).
  - Адрес.
  - Цена:
    - Если скидка не указана — просто цена.
    - Если указана скидка — зачёркнутая исходная цена и новая крупным шрифтом, плюс процент скидки.
- При клике по карточке — модалка с калькулятором по этому лоту:
  - Блок входных данных — только чтение (стоимость, площадь, район, дата РВЭ).
  - Выбор отчёта и сценария доступен.
  - Ползунок срока владения доступен.
  - Пересчёт метрик — так же, как на главной.

---

## 9. Нефункциональные требования

- **Производительность:**
  - Время ответа калькулятора: до 300 мс при среднем сценарии.
  - Парсинг Циан — фоновая задача, UI показывает статус.
- **Масштабируемость:**
  - Возможность горизонтального масштабирования бэкенда и фронта через контейнеризацию.
- **Безопасность:**
  - JWT‑аутентификация, пароли в bcrypt/argon2.
  - Защита от XSS/CSRF на фронте.
  - Валидация вводимых URL (только домен Циан для импорта).
- **Логирование:**
  - Все запросы к `/calc/*` логируются с обезличенной информацией.
  - Ошибки парсера Циан логируются отдельно с текстом объявления (без персональных данных пользователей).
- **Тестирование:**
  - Unit‑тесты для расчётного модуля (все формулы).
  - Интеграционные тесты API.
  - E2E‑тест минимум для сценариев: гость → расчёт, подписчик → импорт Циан → создание коллекции → публичная ссылка.

---

## 10. Дизайн и визуальный стиль

### 10.1. Палитра цветов

- **Основной фон:** тёплый светлый (молочный/бежевый), примерно `#faf8f3` или `#fdf9f5`.
- **Акцент (MatchaCalc зелёный):** мягкий зелёный «матча», примерно `#8b9f6c` или `#9ab974`.
- **Текст основной:** тёмно‑серый, примерно `#2d2d2d` или `#333333`, без резкого контраста.
- **Текст вспомогательный:** средне‑серый, примерно `#666666` или `#777777`.
- **Границы и разделители:** очень светлый серый, примерно `#e8e8e8` или `#eeeeee`.
- **Ошибки:** мягкий красный, примерно `#d9534f` или `#c9302c`.
- **Успех:** мягкий зелёный (другой оттенок), примерно `#5cb85c` или `#5b9e66`.

### 10.2. Типография

- **Шрифт основной:** sans‑serif (например, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif).
- **Кёрнинг:** увеличенный (letter-spacing: 0.5px или 0.3px).
- **Размеры:**
  - H1 (MatchaCalc): 48–56px, font-weight 300–400.
  - H2 (заголовки секций): 28–32px, font-weight 400–500.
  - H3 (подзаголовки): 18–22px, font-weight 500.
  - Текст основной: 14–16px, font-weight 400, line-height 1.6–1.8.
  - Текст вспомогательный: 12–14px, font-weight 400.

### 10.3. Отступы и пространство

- Много воздуха; большие отступы между блоками.
- Margin внутри карточек: 24–32px.
- Padding внутри полей ввода: 12–16px.
- Между элементами в форме: 16–20px.

### 10.4. Компоненты и взаимодействия

- **Кнопки:**
  - Активная CTA: зелёный фон (MatchaCalc зелёный), белый текст, без границы.
  - Вторичная кнопка: прозрачный фон, зелёная граница, зелёный текст.
  - Наведение: лёгкое изменение оттенка, нет тени (минимализм).

- **Ползунок (срок владения):**
  - Рельса: светло‑серая.
  - Ползун: зелёный (MatchaCalc), округлой формы, без тени.
  - При наведении: небольшой прирост размера или изменение оттенка.

- **Модалки:**
  - Полупрозрачная подложка (opacity 0.3–0.5).
  - Белая/молочная карточка в центре.
  - Плавное появление (transition: opacity 200ms).

- **Анимации:**
  - Плавные переходы (transition-duration: 200–300ms).
  - Easing: ease-in-out или cubic-bezier(0.4, 0, 0.2, 1).
  - Hover‑эффекты на кнопках и ссылках (тонкие изменения цвета, без масштабирования).

---

## 11. Технические детали реализации

### 11.1. Бэкенд

**Проектная структура:**

```
matchacalc-backend/
├── app/
│   ├── main.py
│   ├── config.py
│   ├── dependencies.py
│   ├── auth/
│   │   ├── models.py
│   │   ├── schemas.py
│   │   ├── routes.py
│   │   ├── service.py
│   │   └── jwt_handler.py
│   ├── users/
│   │   ├── models.py
│   │   ├── schemas.py
│   │   ├── routes.py
│   │   └── service.py
│   ├── calc/
│   │   ├── models.py
│   │   ├── schemas.py
│   │   ├── routes.py
│   │   ├── service.py
│   │   ├── calculator.py
│   │   └── formulas.py
│   ├── lots/
│   │   ├── models.py
│   │   ├── schemas.py
│   │   ├── routes.py
│   │   ├── service.py
│   │   └── cian_parser.py
│   ├── collections/
│   │   ├── models.py
│   │   ├── schemas.py
│   │   ├── routes.py
│   │   └── service.py
│   ├── reports/
│   │   ├── models.py
│   │   ├── schemas.py
│   │   ├── routes.py
│   │   └── service.py
│   ├── admin/
│   │   ├── routes.py
│   │   └── service.py
│   ├── billing/
│   │   ├── routes.py
│   │   └── service.py
│   ├── ratelimit/
│   │   ├── redis_handler.py
│   │   └── middleware.py
│   └── db/
│       ├── database.py
│       ├── migrations/
│       └── seeds.py
├── tests/
│   ├── test_auth.py
│   ├── test_calc.py
│   ├── test_lots.py
│   ├── test_collections.py
│   └── conftest.py
├── requirements.txt
├── .env.example
├── docker-compose.yml
└── Dockerfile
```

**Зависимости (requirements.txt):**

```
fastapi==0.104.1
uvicorn==0.24.0
sqlalchemy==2.0.23
psycopg2-binary==2.9.9
alembic==1.12.0
redis==5.0.1
celery==5.3.4
python-jose==3.3.0
passlib==1.7.4
bcrypt==4.1.1
pydantic==2.5.0
pydantic-settings==2.1.0
httpx==0.25.2
requests==2.31.0
pytest==7.4.3
pytest-asyncio==0.21.1
```

**Конфигурация (config.py):**

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    DATABASE_URL: str
    REDIS_URL: str
    JWT_SECRET: str
    JWT_ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    
    # Лимиты по частоте запросов (в секундах)
    RATE_LIMIT_GUEST: int = 180  # 3 минуты
    RATE_LIMIT_USER: int = 60    # 1 минута
    RATE_LIMIT_SUBSCRIBER: int = 10  # 10 секунд
    
    # Биллинг
    AGENT_SUBSCRIPTION_PRICE: float = 2999.0
    STRIPE_KEY: str = ""  # Для интеграции платёжки
    
    class Config:
        env_file = ".env"

settings = Settings()
```

**Rate‑limiting middleware (ratelimit/middleware.py):**

```python
from fastapi import Request, HTTPException
from starlette.middleware.base import BaseHTTPMiddleware
import redis
import time

class RateLimitMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        # Определяем лимит по статусу пользователя
        # Если гость — 180 сек, авторизованный — 60 сек, подписчик — 10 сек
        # Используем Redis для хранения счётчиков
        ...
        response = await call_next(request)
        return response
```

**Основной файл (main.py):**

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.auth.routes import router as auth_router
from app.calc.routes import router as calc_router
from app.lots.routes import router as lots_router
from app.collections.routes import router as collections_router
from app.reports.routes import router as reports_router
from app.admin.routes import router as admin_router

app = FastAPI(title="MatchaCalc", version="0.1.0")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

app.include_router(auth_router, prefix="/api/v1/auth", tags=["auth"])
app.include_router(calc_router, prefix="/api/v1/calc", tags=["calc"])
app.include_router(lots_router, prefix="/api/v1/lots", tags=["lots"])
app.include_router(collections_router, prefix="/api/v1/collections", tags=["collections"])
app.include_router(reports_router, prefix="/api/v1/reports", tags=["reports"])
app.include_router(admin_router, prefix="/api/v1/admin", tags=["admin"])

@app.get("/")
def read_root():
    return {"message": "MatchaCalc API v0.1.0"}
```

### 11.2. Фронтенд

**Структура проекта:**

```
matchacalc-frontend/
├── index.html
├── login.html
├── register.html
├── subscription.html
├── collections.html
├── contacts.html
├── css/
│   ├── style.css
│   ├── variables.css
│   └── responsive.css
├── js/
│   ├── api.js
│   ├── calculator.js
│   ├── collections.js
│   ├── auth.js
│   ├── ui.js
│   └── utils.js
└── assets/
    ├── logo.svg
    └── icons/
```

**Стартовые файлы:**

- `index.html` — главная страница с калькулятором.
- `css/variables.css` — CSS‑переменные для цветов и типографии.
- `js/api.js` — базовый клиент для HTTP‑запросов к бэкенду.
- `js/calculator.js` — логика калькулятора и ползунка.
- `js/collections.js` — управление коллекциями и импортом Циан.

---

## 12. Тестирование и развёртывание

### 12.1. Unit‑тесты (calc/formulas)

```python
# test_calc.py
import pytest
from app.calc.formulas import (
    calculate_rent_income,
    calculate_sale_profit,
    calculate_payback_rent,
    calculate_double_price,
    calculate_npv,
    calculate_irr
)

def test_rent_income():
    # Проверка расчёта арендного дохода с учётом 6 месяцев подготовки
    ...

def test_irr():
    # Проверка расчёта IRR по денежным потокам
    ...
```

### 12.2. Docker‑развёртывание

**Dockerfile для бэкенда:**

```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**docker-compose.yml:**

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: matchacalc
      POSTGRES_USER: matchacalc
      POSTGRES_PASSWORD: secret
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7

  backend:
    build: ./matchacalc-backend
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://matchacalc:secret@postgres:5432/matchacalc
      REDIS_URL: redis://redis:6379
      JWT_SECRET: your-secret-key
    depends_on:
      - postgres
      - redis

  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./matchacalc-frontend:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend

volumes:
  postgres_data:
```

---

## 13. Договоры и юридические документы

### 13.1. Дисклеймер (на каждой странице расчётов)

```
Важное сообщение: Данный калькулятор предоставляет информацию 
в целях анализа и не является индивидуальной инвестиционной 
рекомендацией. Расчёты основаны на открытых данных консалтинговых 
отчётов и не гарантируют доходность инвестиций. Перед принятием 
решения об инвестировании проконсультируйтесь с профессиональным 
финансовым консультантом. Компания не несёт ответственности 
за убытки, понесённые на основе использования данного сервиса.
```

### 13.2. Политика обработки персональных данных

Документ, соответствующий российскому законодательству (ФЗ‑152 «О защите персональных данных»), описывающий:

- какие данные собираются;
- как они используются;
- сроки хранения;
- права пользователя.

### 13.3. Условия использования

Базовый текст с указанием ограничений ответственности, запретов и порядка разрешения споров.

---

## 14. Фазы разработки и MVP

### Фаза 1 (MVP, ~4 недели)

- Аутентификация (email/пароль).
- Калькулятор с ручным вводом.
- Статические и динамические метрики (без NPV/IRR в первой версии).
- Главная страница и тариф‑страница.
- Rate‑limiting по IP для гостей.
- Docker‑развёртывание на тестовом сервере.

### Фаза 2 (~3 недели)

- Добавление NPV и IRR в калькулятор.
- Интеграция с парсером Циан.
- Авторизованный доступ и подписка.
- Платёжка (Stripe / Яндекс.касса).

### Фаза 3 (~2–3 недели)

- Функционал коллекций.
- Публичные ссылки на коллекции.
- Модалка с калькулятором по лоту.
- Админ‑панель для управления отчётами и сценариями.

### Фаза 4+ (далее)

- API для застройщиков.
- Мобильное приложение (опционально).
- Расширение на другие сегменты недвижимости (логистика, розница и т.п.).

---

## 15. Контакты и поддержка

- **Email поддержки:** support@matchacalc.ru
- **Форма обратной связи:** На странице /contacts
- **Аналитика:** Google Analytics + внутреннее логирование через Sentry.

---

**ТЗ готово для передачи разработчикам. Cursor/агент может начинать работу с Фазы 1 (MVP).**
